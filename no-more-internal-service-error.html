<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
	<meta property="og:site_name" content="technical blog of pnr.me"/>
	<title>How we solved the immense pain of error code 500:internal service error</title>
        <link rel="stylesheet" href="http://blog.pnr.me/theme/css/main.css" />
        <link href="http://blog.pnr.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="technical blog of pnr.me Atom Feed" />
	<meta property="og:image" content="https://fbcdn-sphotos-g-a.akamaihd.net/hphotos-ak-ash3/1412239_168537233354082_341502953_o.jpg"/>
 	<link rel="author" href="https://plus.google.com/u/0/+SalilPanikkaveettil?rel=author">

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blog.pnr.me/">technical blog of pnr.me </a></h1>
                <nav><ul>
                    <li><a href="http://pnr.me">pnr.me</a></li>
                    <li><a href="http://blog.pnr.me/category/misc.html">misc</a></li>
                    <li class="active"><a href="http://blog.pnr.me/category/tech.html">tech</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://blog.pnr.me/no-more-internal-service-error.html" rel="bookmark"
           title="Permalink to How we solved the immense pain of error code 500:internal service error">How we solved the immense pain of error code 500:internal service error</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-11-27T00:00:00">
                Wed 27 November 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.pnr.me/author/salil-panikkaveettil.html">Salil Panikkaveettil</a>
        </address>
<p>In <a href="http://blog.pnr.me/category/tech.html">tech</a>. </p>
<p>tags: <a href="http://blog.pnr.me/tag/500.html">500</a><a href="http://blog.pnr.me/tag/error.html">error</a><a href="http://blog.pnr.me/tag/internal-service-error.html">internal service error</a></p>
</footer><!-- /.post-info -->      <p>We explained earlier <a href="http://blog.pnr.me/how-we-got-our-first-thousand-visitors.html" title="how our servers crashed after pnr.me was shared by Alok Rodinhood Kejriwal">how our servers went down crashing</a>, after being shared by <a href="https://www.facebook.com/rodinhood" title="Alok Rodinhood Kejriwal">mr rodinhood</a>. We needed a fix and we needed it fast</p>
<h2>What the problem was not</h2>
<p>One of our first assumption was that the error had something to do with apache. Reading a lot of hackernews makes you believe that apache is the culprit behind any server side error and nginx is the solution. But as we deepdived into the problem some things became very clear</p>
<ul>
<li>Our apache server was never throttled</li>
<li>What went down was the application itself, to be more clear the <a href="http://pnr.me/predictor" title="pnr prediction engine">prediction engine of pnr.me</a></li>
</ul>
<h2>skeleton of pnr.me</h2>
<p>pnr.me has two main components, a flask powered web app and a python predictor deamon communicating with each other using zmq. There is good reason why we arrived at this design. Predictor deamon is a number crunching application which required good amount of memory. To make matters worse, it was using <a href="http://www.scipy.org/" title="scientific python">scipy</a> which is a memory heavy python library. Hence it was not advisable to have the predictor application embedded in the web app as mod_wsgi will have a tough time serving this memory heavy app. </p>
<p>Now call it bad code, our predictor deamon was throwing some exception and dying at regular intervals. To make the matter worse, we had not set up any kind of monitoring mechanism which would inform us when the predictor deamon goes down. As a ugly hack, we stumbled upon this beatiful code which would respawn a deamon if it gets killed or if it is stopped by some random reason</p>
<div class="highlight"><pre><span class="k">until</span> <span class="o">(</span>python predictor_deamon.py<span class="o">)</span>; <span class="k">do</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Server &#39;myserver&#39; crashed with exit code $?.  Respawning..&quot;</span> &gt;&amp;2
    sleep 1
<span class="k">done</span>
</pre></div>


<p>Internal service errors would still show for users but atleast it wouldn`t affect others from accessing the website</p>
<h2>The web app</h2>
<p>Once internal server error of predictor deamon got almost resolved, we were quite sure that we would not get any more internal service errors. As the great <a href="http://www.imdb.com/character/ch0000164/quotes" title="Thorin Oakenshield">Thorin Oakenshield</a> once said "I've never been so wrong in all my life".</p>
<p>We deploy <a href="http://pnr.me" title="pnr.me">pnr.me</a> after doing basic testing. But these basic tests cannot handle blackswan errors like the one i recently faced. I was getting pymongo.errors.OperationFailure: quota exceeded error and because of this, the webapp was throwing an internal service error. How did pnr.me solve pymongo.errors.OperationFailure: quota exceeded when using MongoLab is a story for another blog post.</p>
<p>We cannot solve all Blackswan events however hard we try. We needed an alert mechanism by which we could react fast to these errors. By following the beautiful articles on <a href="http://flask.pocoo.org/docs/errorhandling/" title="how to send automated mails when flask server throws an error">how to set up a SMTPHandler for flask</a> and how to use <a href="http://mynthon.net/howto/-/python/python%20-%20logging.SMTPHandler-how-to-use-gmail-smtp-server.txt" title="How to use Gmail SMTP server with logging module">GMail SMTP server with logging module</a>, we created a alert mechanism which would mail us the second any error is thrown by the flask web server</p>
<h2>Final setup and improvement</h2>
<ul>
<li>We will be alerted by email when some error is thrown by flask.</li>
<li>Our predictor deamon will respawn within a second of dying. We can fix the error later as all the errors are anyways logged</li>
<li>A big TODO is to create such alerts for python jobs which run independant of the flask web service</li>
</ul>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "no-more-internal-service-error.html";
        var disqus_url = "http://blog.pnr.me/no-more-internal-service-error.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://pnrme.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.pnr.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://plus.google.com/+PnrMe/posts">google plus</a></li>
                            <li><a href="https://www.facebook.com/pnr.me">facebook</a></li>
                            <li><a href="https://twitter.com/pnrme">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45194026-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'pnrme';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <!-- AddThis Smart Layers BEGIN -->
    <!-- Go to http://www.addthis.com/get/smart-layers to customize -->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5292fa9d3ef576d4"></script>
    <script type="text/javascript">
        addthis.layers({
            'theme' : 'transparent',
            'share' : {
                'position' : 'left',
                'numPreferredServices' : 5
            },
            'follow' : {
                'services' : [
                    {'service': 'facebook', 'id': 'pnr.me'},
                    {'service': 'twitter', 'id': 'pnrme'},
                    {'service': 'google_follow', 'id': '+PnrMe'}
                ]
            }
        });
    </script>
    <!-- AddThis Smart Layers END -->
</body>
</html>